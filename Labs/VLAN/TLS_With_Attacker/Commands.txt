## ğŸ“Š Network Architecture

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚            Linux Network Namespaces             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚   ecuA       â”‚   ecuC       â”‚   ecuD           â”‚
â”‚  (Tester)    â”‚   (ECU)      â”‚  (Attacker)      â”‚
â”‚  10.0.0.20   â”‚  10.0.0.10   â”‚  10.0.0.30       â”‚
â”‚              â”‚              â”‚                  â”‚
â”‚  Client      â”‚  Server      â”‚  MITM Proxy      â”‚
â”‚  DoIP/UDS    â”‚  DoIP/UDS    â”‚  ARP Poisoning   â”‚
â”‚  TLS 1.2     â”‚  TLS 1.1-1.2 â”‚  Packet Modify   â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚              â”‚                â”‚
       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              br-doip (Bridge)
              10.0.0.0/24
```


## ğŸ› ï¸ Installation & Setup

### Step 1: Create Project Folder
#### Download and place all project files in Project Folder:

### Step 2: Open Terminal and Install pyenv (Python Version Manager)

```bash
curl https://pyenv.run | bash
```

### Step 3: Configure Shell

**For Zsh:**
```bash
echo 'export PYENV_ROOT="$HOME/.pyenv"' >> ~/.zshrc
echo 'export PATH="$PYENV_ROOT/bin:$PATH"' >> ~/.zshrc
echo 'eval "$(pyenv init -)"' >> ~/.zshrc
source ~/.zshrc
```
**For Fish Shell:**
```bash
echo 'set -gx PYENV_ROOT $HOME/.pyenv' >> ~/.config/fish/config.fish
echo 'set -gx PATH $PYENV_ROOT/bin $PATH' >> ~/.config/fish/config.fish
echo 'status is-interactive; and pyenv init --path | source' >> ~/.config/fish/config.fish
echo 'pyenv init - | source' >> ~/.config/fish/config.fish
source ~/.config/fish/config.fish
```
**For Bash:**
```bash
echo 'export PYENV_ROOT="$HOME/.pyenv"' >> ~/.bashrc
echo 'export PATH="$PYENV_ROOT/bin:$PATH"' >> ~/.bashrc
echo 'eval "$(pyenv init -)"' >> ~/.bashrc
source ~/.bashrc
```
### Step 4: Install Python 3.12

```bash
# Install Python 3.12.7
pyenv install 3.12.7

# Navigate to project folder
cd PROJECT_FILE

# Set Python 3.12 for this project
pyenv local 3.12.7

# Verify installation (should output: Python 3.12.7)
python --version
```

### Step 5: Install Python Dependencies

```bash
pip install scapy netifaces
```


### Step 6: Setup Network Lab

```bash
# Make setup script executable
chmod +x setup_doip_lab.sh

# Run network setup (creates namespaces and bridge)
sudo ./setup_doip_lab.sh
```

**Expected Output:**
```
[+] DoIP bridge lab ready
[+] Nodes:
    ecuA (Tester)   -> 10.0.0.20
    ecuC (ECU)      -> 10.0.0.10
    ecuD (Attacker) -> 10.0.0.30
```

---

## ğŸš€ Running the Lab

You'll need **3 terminal windows** open simultaneously.

### Terminal 1: ECU Server (Target)

```bash
# Navigate to project folder
cd PROJECT_FOLDER

# Enter ECU namespace
sudo ip netns exec ecuC bash

# Run server (âš ï¸ IMPORTANT: Replace 'user' with YOUR username)
/home/user/.pyenv/shims/python3.12 ecu_c_doip_server.py
```

**Expected Output:**
```
[ECU] âš ï¸  VULNERABLE DoIP ECU
[ECU] âš ï¸  Accepts TLS 1.1-1.2, PREFERS 1.2 (NO downgrade protection!)
[ECU] ğŸ“¡ UDP discovery service on port 13400
[ECU] âš ï¸  VULNERABLE DoIP Server on port 13401
```

### Terminal 2: Attacker (MITM)

```bash
# Navigate to project folder
cd PROJECT_FOLDER

# Enter Attacker namespace
sudo ip netns exec ecuD bash

# Run attacker (âš ï¸ IMPORTANT: Replace 'user' with YOUR username)
/home/user/.pyenv/shims/python3.12 attacker.py
```

**Menu will appear:**
```
Options:
  1 - Start Active MITM Attack
  2 - Stop Attack
  3 - Exit

Select option: 1
```

Press **`1`** then **`ENTER`** to start the attack.

**Expected Output:**
```
[INFO] Setting up iptables redirect rules...
[ATTACK] ğŸ­ Starting ARP poisoning...
[SUCCESS] âœ… ARP poisoning active
[SUCCESS] âœ… TCP proxy active
ğŸ¯ Attack is LIVE!
```

### Terminal 3: Client/Tester

```bash
# Navigate to project folder
cd PROJECT_FOLDER

# Enter Tester namespace
sudo ip netns exec ecuA bash

# Run client (âš ï¸ IMPORTANT: Replace 'user' with YOUR username)
/home/user/.pyenv/shims/python3.12 ecu_a_doip_client.py
```

**Expected Output (Attack Successful):**
```
[INFO] ğŸ“¡ Step 1: UDP Vehicle Discovery (unencrypted)
[ OK ] ECU Found: 10.0.0.10

[INFO] ğŸ”’ Step 2: TLS 1.2 Handshake on port 13401
[WARN] âš ï¸  TLS 1.2 handshake failed (possible downgrade attack)
[INFO] ğŸ”„ Retrying with TLS 1.1 (downgraded)...

[INFO] ğŸ”» Step 2: TLS 1.1 Handshake on port 13401 (downgraded)
[ OK ] âœ… TLS Handshake Complete!
[ OK ] ğŸ” Protocol: TLSv1.1
[WARN] âš ï¸  Using downgraded TLS 1.1!
[SUCCESS] âœ… Connected with downgraded TLS 1.1!
[WARN] âš ï¸  This connection is vulnerable! Downgrade attack succeeded!
```

---

## ğŸ”¬ Understanding the Attack

### What Happens Without Attack

```
Client --[TLS 1.2 Hello]--> Server
Server --[TLS 1.2 Accept]--> Client
âœ… Secure TLS 1.2 connection established
```

### What Happens With Attack

```
1. Client --[TLS 1.2 Hello]--> Attacker (ARP poisoned)
2. Attacker modifies packet: TLS 1.2 â†’ TLS 1.1
3. Attacker --[TLS 1.1 Hello]--> Server
4. Server rejects (protocol mismatch)
5. Attacker disconnects MITM
6. Client retries directly --[TLS 1.1 Hello]--> Server
7. Server accepts TLS 1.1 âš ï¸ VULNERABLE!
```

### Attack Output in Terminal 2 (Attacker)

```
[SUCCESS] âœ… Connected to real server 10.0.0.10:13401
[INFO] ğŸ“¥ Clientâ†’Server: Intercepted TLS Client Hello (TLS 1.2)
[ATTACK] ğŸ”» DOWNGRADED: TLS 1.2 â†’ TLS 1.1 (packet #1)
[ATTACK] ğŸ”Œ Downgrade sent! Disconnecting MITM...
[ATTACK] ğŸ”’ Stopping ARP poisoning...
[INFO] Restoring ARP tables...
[SUCCESS] âœ… MITM disconnected!
[SUCCESS] âœ… Client will now reconnect directly to server
[SUCCESS] âœ… Server may accept downgraded TLS 1.0 on next attempt
```
